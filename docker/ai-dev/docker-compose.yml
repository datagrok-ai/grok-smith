services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: datagrok
      POSTGRES_PASSWORD: datagrok_local
      POSTGRES_DB: datagrok_dev
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ../../packages/core-schema/sql/:/docker-entrypoint-initdb.d/
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U datagrok -d datagrok_dev"]
      interval: 5s
      timeout: 5s
      retries: 5

  ai-dev:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${TTYD_PORT:-7681}:7681"
      - "${APP_PORT:-5173}:5173"       # Vite dev server
      - "${API_PORT:-3000}:3000"       # API server
    environment:
      - DATABASE_URL=postgresql://datagrok:datagrok_local@postgres:5432/datagrok_dev
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - REPO=${REPO:-your-org/grok-smith}
      - BRANCH=${BRANCH:-}
      - TASK=${TASK:-}
      - GIT_USER_NAME=${GIT_USER_NAME:-AI Developer}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL:-ai-dev@datagrok.ai}
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      - REVIEWERS=${REVIEWERS:-}
      - PR_LABELS=${PR_LABELS:-ai-generated}
      - TTYD_PORT=7681
      - HOST_TTYD_PORT=${TTYD_PORT:-7681}
      - HOST_APP_PORT=${APP_PORT:-5173}
      - HOST_API_PORT=${API_PORT:-3000}
    volumes:
      # Mount host Claude auth for Max/Pro subscription (login persists across runs)
      - ${CLAUDE_CONFIG_DIR:-~/.claude}:/home/dev/.claude
    restart: "no"

volumes:
  pgdata:
